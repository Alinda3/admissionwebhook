name: main

on: 
  workflow_dispatch:

env:
  HELM_EXPERIMENTAL_OCI: 1
  HELM_VERSION_TO_INSTALL: 3.5.0
  ACR_NAME: tsaktest
  ACR_REPO_NAME: helm/test
  ACR_PUSH_USER: github-admission-webhook
jobs:
  docker_build_push_acr:
    name: 'Docker Build and Push to ACR'
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
  
    steps:
    # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v2
  
    - name: 'Docker Login'
      uses: azure/docker-login@v1
      with:
        login-server: ${{ env.ACR_NAME }}.azurecr.io
        username: ${{ env.ACR_PUSH_USER }}
        password: ${{ secrets.ACR_PUSH_TOKEN }}
 
    - name: Build the frontend image and push it to ACR
      uses: docker/build-push-action@v2
      with:
        push: true
        file: ./Dockerfile
  build:
    name: build and push helm
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v2
        name: checkout repo
      
      - name: install helm
        uses: Azure/setup-helm@v1
          
      - name: login to acr using helm
        run: |
          helm registry login ${{ env.ACR_NAME }}.azurecr.io --username ${{ env.ACR_PUSH_USER }} --password ${{ secrets.ACR_PUSH_TOKEN }}
          
      - name: save helm chart to local registry
        run: |
          helm chart save $/src/azure-vote-helm-chart/ $.azurecr.io/$:latest
          
      - name: publish chart to acr
        run: |
            helm chart push $.azurecr.io/$:latest

